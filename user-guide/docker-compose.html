
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Docker Compose · Ambassador: open source API Gateway for microservices and Kubernetes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/ambassador-v0.40.0-docs/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/ambassador-v0.40.0-docs/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../concepts/developers.html" />
    
    
    <link rel="prev" href="../about/quickstart.html" />
    

    </head>
    <body>
        
    <noscript>
        <iframe src="//www.googletagmanager.com/ns.html?id=GTM-TPMQ838" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),
                dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-TPMQ838');
    </script>
    
<div class="book">
    <div class="book-summary">
        
<a href="/" class="logo__link">
    <img class="logo" src="/ambassador-v0.40.0-docs/images/ambassador-logo.svg" alt="logo">
</a>


            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://blog.getambassador.io">
            
                    
                    Blog
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Getting Started</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../about/why-ambassador.html">
            
                <a href="../about/why-ambassador.html">
            
                    
                    Why Ambassador?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../about/features-and-benefits.html">
            
                <a href="../about/features-and-benefits.html">
            
                    
                    Features and Benefits
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="install.html">
            
                <a href="install.html">
            
                    
                    Installing Ambassador
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="getting-started.html">
            
                <a href="getting-started.html">
            
                    
                    Kubernetes (YAML)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="helm.html">
            
                <a href="helm.html">
            
                    
                    Kubernetes (Helm)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.3" data-path="../about/quickstart.html">
            
                <a href="../about/quickstart.html">
            
                    
                    Docker Quickstart
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.3.4" data-path="docker-compose.html">
            
                <a href="docker-compose.html">
            
                    
                    Docker Compose
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Concepts</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../concepts/developers.html">
            
                <a href="../concepts/developers.html">
            
                    
                    Decentralized configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../concepts/architecture.html">
            
                <a href="../concepts/architecture.html">
            
                    
                    Ambassador Architecture
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" >
            
                <a target="_blank" href="https://blog.getambassador.io/envoy-vs-nginx-vs-haproxy-why-the-open-source-ambassador-api-gateway-chose-envoy-23826aed79ef">
            
                    
                    Why Ambassador uses Envoy Proxy
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../about/microservices-api-gateways.html">
            
                <a href="../about/microservices-api-gateways.html">
            
                    
                    Microservices API Gateways
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../concepts/using-ambassador-in-org.html">
            
                <a href="../concepts/using-ambassador-in-org.html">
            
                    
                    Using Ambassador in your organization
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Guides</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="auth-tutorial.html">
            
                <a href="auth-tutorial.html">
            
                    
                    Adding Authentication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="rate-limiting-tutorial.html">
            
                <a href="rate-limiting-tutorial.html">
            
                    
                    Adding Rate Limiting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="tracing-tutorial.html">
            
                <a href="tracing-tutorial.html">
            
                    
                    Adding Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="grpc.html">
            
                <a href="grpc.html">
            
                    
                    Use gRPC with Ambassador
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="tls-termination.html">
            
                <a href="tls-termination.html">
            
                    
                    TLS Termination
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="with-istio.html">
            
                <a href="with-istio.html">
            
                    
                    Istio and Ambassador
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" >
            
                <a target="_blank" href="https://blog.getambassador.io/howto/home">
            
                    
                    More guides
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Reference</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../reference/configuration.html">
            
                <a href="../reference/configuration.html">
            
                    
                    Configuring Ambassador
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../reference/modules.html">
            
                <a href="../reference/modules.html">
            
                    
                    Core Configuration
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1.1" data-path="../reference/core/tls.html">
            
                <a href="../reference/core/tls.html">
            
                    
                    TLS and X-Forwarded-Proto
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../reference/mappings.html">
            
                <a href="../reference/mappings.html">
            
                    
                    Configuring Services
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.2.1" data-path="../reference/canary.html">
            
                <a href="../reference/canary.html">
            
                    
                    Canary Releases
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.2" data-path="../reference/cors.html">
            
                <a href="../reference/cors.html">
            
                    
                    Cross Origin Resource Sharing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.3" data-path="../reference/override.html">
            
                <a href="../reference/override.html">
            
                    
                    Custom Envoy config
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.4" data-path="../reference/headers.html">
            
                <a href="../reference/headers.html">
            
                    
                    Header-based routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.5" data-path="../reference/host.html">
            
                <a href="../reference/host.html">
            
                    
                    Host Header
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.6" data-path="../reference/rate-limits.html">
            
                <a href="../reference/rate-limits.html">
            
                    
                    Rate Limits
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.7" data-path="../reference/redirects.html">
            
                <a href="../reference/redirects.html">
            
                    
                    Redirects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.8" data-path="../reference/add_request_headers.html">
            
                <a href="../reference/add_request_headers.html">
            
                    
                    Request Headers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.9" data-path="../reference/rewrites.html">
            
                <a href="../reference/rewrites.html">
            
                    
                    Rewrites
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.10" data-path="../reference/shadowing.html">
            
                <a href="../reference/shadowing.html">
            
                    
                    Traffic Shadowing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="../reference/services/services.html">
            
                <a href="../reference/services/services.html">
            
                    
                    External Services
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.3.1" data-path="../reference/services/auth-service.html">
            
                <a href="../reference/services/auth-service.html">
            
                    
                    Authentication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3.2" data-path="../reference/services/rate-limit-service.html">
            
                <a href="../reference/services/rate-limit-service.html">
            
                    
                    Rate Limiting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3.3" data-path="../reference/services/tracing-service.html">
            
                <a href="../reference/services/tracing-service.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.1.4" data-path="../reference/advanced.html">
            
                <a href="../reference/advanced.html">
            
                    
                    Advanced configuration topics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../reference/running.html">
            
                <a href="../reference/running.html">
            
                    
                    Running Ambassador
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.2.1" data-path="../reference/diagnostics.html">
            
                <a href="../reference/diagnostics.html">
            
                    
                    Diagnostics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.2" data-path="../reference/ambassador-with-aws.html">
            
                <a href="../reference/ambassador-with-aws.html">
            
                    
                    Ambassador with AWS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../reference/upgrading.html">
            
                <a href="../reference/upgrading.html">
            
                    
                    Upgrading Ambassador
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../reference/statistics.html">
            
                <a href="../reference/statistics.html">
            
                    
                    Statistics and Monitoring
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Developers</li>
        
        
    
        <li class="chapter " data-level="6.1" >
            
                <a target="_blank" href="https://github.com/datawire/ambassador/blob/master/BUILDING.md">
            
                    
                    Building Ambassador (GitHub)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" >
            
                <a target="_blank" href="https://github.com/datawire/ambassador/blob/master/CHANGELOG.md">
            
                    
                    Changelog (GitHub)
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Need Help?</li>
        
        
    
        <li class="chapter " data-level="7.1" >
            
                <a target="_blank" href="https://d6e.co/slack">
            
                    
                    Ask on Slack
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" >
            
                <a target="_blank" href="https://github.com/datawire/ambassador/issues/new">
            
                    
                    File a GitHub Issue
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" >
            
                <a target="_blank" href="https://www.datawire.io">
            
                    
                    Visit Datawire.io
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        

    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Docker Compose</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
<a id="datawire-breadcrumb" href="https://datawire.io/learn/open-source-docs">
    ← Back to Datawire Open Source Documentation
</a>

                                <h1 id="deploying-ambassador-to-docker-compose-for-local-development">Deploying Ambassador to Docker Compose for local development</h1>
<p>Docker Compose is useful for local development where Minikube may be undesirable. This guide is not intended for production deployments but it is intended to allow developers to quickly try out Ambassador features in a simple, local environment.</p>
<p><em>It is important to note that any change to Ambassador&apos;s configuration using this method requires a restart of the Ambassador container and thus downtime.</em></p>
<h2 id="prerequisites">Prerequisites</h2>
<p>We assume that you have the latest version of Docker at the time of the writing of this guide.</p>
<h2 id="1-creating-a-simple-docker-compose-environment">1. Creating a simple Docker Compose environment</h2>
<p>In this guide we will begin with a basic Ambassador API Gateway and add features over time. Not all features will be covered but by the end of this read you should know how to configure Ambassador to meet your local development needs.</p>
<h3 id="create-docker-composeyaml-file">Create docker-compose.yaml file</h3>
<p>In a working directory create a file called <code>docker-compose.yaml</code> with this content:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&apos;3.5&apos;</span>

<span class="hljs-attr">services:</span>
<span class="hljs-attr">  ambassador:</span>
<span class="hljs-attr">    image:</span> quay.io/datawire/ambassador:<span class="hljs-number">0.38</span><span class="hljs-number">.0</span>
<span class="hljs-attr">    ports:</span>
    <span class="hljs-comment"># expose port 80 via 8080 on the host machine</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">8080</span>:<span class="hljs-number">80</span>
<span class="hljs-attr">    volumes:</span>
    <span class="hljs-comment"># mount a volume where we can inject configuration files</span>
<span class="hljs-bullet">    -</span> ./config:/ambassador/ambassador-config
</code></pre>
<p>Note the mounted volume. When Ambassador bootstraps on container startup it checks the <code>/ambassador/ambassador-config</code> directory for configuration files. We will use this behavior to configure ambassador.</p>
<h3 id="test-using-ambassadors-diagnostics">Test using Ambassador&apos;s Diagnostics</h3>
<p>Run your compose environment and curl the diagnostics endpoint to ensure the compose file is working as expected.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># start your containers in the background</span>
docker-compose up <span class="hljs-_">-d</span>

<span class="hljs-comment"># curl for the response header from the diagnostics endpoint</span>
curl -I localhost:8080/ambassador/v0/diag/

<span class="hljs-comment"># the response code should be 200</span>
HTTP/1.1 200 OK
server: envoy
date: Fri, 17 Aug 2018 21:07:37 GMT
content-type: text/html; charset=utf-8
content-length: 6459
x-envoy-upstream-service-time: 10
</code></pre>
<h2 id="2-make-a-change-to-the-default-configuration">2. Make a change to the default configuration</h2>
<p>Let&apos;s turn off the diagnostics page to demonstrate how we will enable and configure Ambassador.</p>
<p>Create a <code>config</code> folder (which must match the mounted volume in the <code>docker-compose.yaml</code> file) and add a file called <code>ambassador.yaml</code> to the directory.
(Note: Configuration files can have any name or combined into the same yaml file)</p>
<pre><code class="lang-bash">mkdir config
touch config/ambassador.yaml
</code></pre>
<p>Set the contents of the <code>config/ambassador.yaml</code> to this yaml configuration:</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> ambassador/v0
<span class="hljs-attr">kind:</span> Module
<span class="hljs-attr">name:</span> ambassador
<span class="hljs-attr">config:</span>
<span class="hljs-attr">  diagnostics:</span>
    <span class="hljs-comment"># Stop the diagnostics endpoint from being publicly available</span>
<span class="hljs-attr">    enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>Now restart ambassador and test the diagnostics endpoint to ensure our configuration is in use:</p>
<pre><code class="lang-bash"><span class="hljs-comment"># restart the container to pick up new configuration settings</span>
docker-compose up <span class="hljs-_">-d</span> -V ambassador

<span class="hljs-comment"># curl the same diagnostics endpoint as the previous step</span>
curl -I localhost:8080/ambassador/v0/diag/

<span class="hljs-comment"># the response code should be 404</span>
HTTP/1.1 404 Not Found
date: Fri, 17 Aug 2018 21:18:25 GMT
server: envoy
content-length: 0
</code></pre>
<p>Feel free to re-enable the diagnostics endpoint.</p>
<h2 id="3-add-a-route-mapping">3. Add a route mapping</h2>
<p>Now that we have demonstrated that we can modify the configuration let&apos;s add a mapping to route to <code>http://demo.getambassador.io/qotm/</code> service.</p>
<p>Create a new file <code>config/mapping-qotm.yaml</code> with these contents:</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> ambassador/v0
<span class="hljs-attr">kind:</span>  Mapping
<span class="hljs-attr">name:</span>  qotm_mapping
<span class="hljs-attr">prefix:</span> /qotm/
<span class="hljs-attr">rewrite:</span> /qotm/
<span class="hljs-attr">service:</span> demo.getambassador.io
</code></pre>
<p>Once again, restart ambassador and test the new mapping:</p>
<pre><code class="lang-bash"><span class="hljs-comment"># restart the container to pick up new configuration settings</span>
docker-compose up <span class="hljs-_">-d</span> -V ambassador

<span class="hljs-comment"># curl the quote-of-the-moment service</span>
curl localhost:8080/qotm/quote/1

<span class="hljs-comment"># the response body should be a json object with a quote</span>
{
  <span class="hljs-string">&quot;hostname&quot;</span>: <span class="hljs-string">&quot;qotm-3716059461-47tnl&quot;</span>,
  <span class="hljs-string">&quot;ok&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;quote&quot;</span>: <span class="hljs-string">&quot;The light at the end of the tunnel is interdependent on the relatedness of motivation, subcultures, and management.&quot;</span>,
  <span class="hljs-string">&quot;time&quot;</span>: <span class="hljs-string">&quot;2018-08-17T21:29:24.690950&quot;</span>,
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;1.3&quot;</span>
}
</code></pre>
<h2 id="3-add-a-route-mapping-to-an-internal-service">3. Add a route mapping to an internal service</h2>
<p>While routing to an external service is useful, more often than not our Docker Compose environment will contain a number of services that need routing.</p>
<h3 id="add-the-qotm-service-to-the-docker-composeyaml-file">Add the qotm service to the docker-compose.yaml file</h3>
<p>Edit the <code>docker-compose.yaml</code> file and add a new <code>qotm</code> service. It should now look like this:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&apos;3.5&apos;</span>

<span class="hljs-attr">services:</span>
<span class="hljs-attr">  ambassador:</span>
<span class="hljs-attr">    image:</span> quay.io/datawire/ambassador:<span class="hljs-number">0.38</span><span class="hljs-number">.0</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">8080</span>:<span class="hljs-number">80</span>
<span class="hljs-attr">    volumes:</span>
    <span class="hljs-comment"># mount a volume where we can inject configuration files</span>
<span class="hljs-bullet">    -</span> ./config:/ambassador/ambassador-config
<span class="hljs-attr">  qotm:</span>
<span class="hljs-attr">    image:</span> datawire/qotm:<span class="hljs-number">1.3</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">5000</span>
</code></pre>
<h3 id="update-the-mapping-qotmyaml-file-to-route-to-our-internal-qotm-service">Update the mapping-qotm.yaml file to route to our internal qotm service</h3>
<p>Edit the <code>config/mapping-qotm.yaml</code> file and modify the <code>service</code> and <code>rewrite</code> field. It should now look like this:</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> ambassador/v0
<span class="hljs-attr">kind:</span>  Mapping
<span class="hljs-attr">name:</span>  qotm_mapping
<span class="hljs-attr">prefix:</span> /qotm/
<span class="hljs-comment"># remove the qotm prefix when talking to the qotm service</span>
<span class="hljs-attr">rewrite:</span> /
<span class="hljs-comment"># change the `service` parameter to the name of our service with the port</span>
<span class="hljs-attr">service:</span> qotm:<span class="hljs-number">5000</span>
</code></pre>
<h3 id="restart-ambassador-and-test">Restart Ambassador and test</h3>
<p>Re-run the same test as in the previous section to ensure the route works as before. This time we will need to bring up the new service first.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># start all new containers (eg. qotm)</span>
docker-compose up <span class="hljs-_">-d</span>

<span class="hljs-comment"># restart the container to pick up new configuration settings</span>
docker-compose up <span class="hljs-_">-d</span> -V ambassador

<span class="hljs-comment"># curl the quote-of-the-moment service</span>
curl localhost:8080/qotm/quote/1

<span class="hljs-comment"># the response body should be a json object with a quote</span>
{
  <span class="hljs-string">&quot;hostname&quot;</span>: <span class="hljs-string">&quot;qotm-3716059461-47tnl&quot;</span>,
  <span class="hljs-string">&quot;ok&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;quote&quot;</span>: <span class="hljs-string">&quot;The light at the end of the tunnel is interdependent on the relatedness of motivation, subcultures, and management.&quot;</span>,
  <span class="hljs-string">&quot;time&quot;</span>: <span class="hljs-string">&quot;2018-08-17T21:29:24.690950&quot;</span>,
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;1.3&quot;</span>
}
</code></pre>
<h3 id="verify-that-the-local-qotm-container-is-serving-requests">Verify that the local qotm container is serving requests</h3>
<p>To ensure that the routing changes worked inspect the docker-compose logs to see the output from the local qotm service. It should look something like this:</p>
<pre><code class="lang-bash">&gt; docker-compose logs
Attaching to ambassador-compose_qotm_1
qotm_1        | 2018-08-17 21:53:13 QotM 1.3 INFO: initializing on <span class="hljs-built_in">local</span>-qotm:5000
qotm_1        | 2018-08-17 21:53:13 QotM 1.3 INFO:  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
qotm_1        | 2018-08-17 21:53:13 QotM 1.3 INFO:  * Restarting with <span class="hljs-built_in">stat</span>
qotm_1        | 2018-08-17 21:53:14 QotM 1.3 INFO: initializing on <span class="hljs-built_in">local</span>-qotm:5000
qotm_1        | 2018-08-17 21:53:14 QotM 1.3 WARNING:  * Debugger is active!
qotm_1        | 2018-08-17 21:53:14 QotM 1.3 INFO:  * Debugger PIN: 336-275-311
qotm_1        | 2018-08-17 21:53:41 QotM 1.3 DEBUG: GET /: session None, username None, handler statement
qotm_1        | 2018-08-17 21:53:41 QotM 1.3 INFO: 172.19.0.3 - - [17/Aug/2018 21:53:41] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 -
</code></pre>
<h2 id="4-add-authentication">4. Add Authentication</h2>
<p>The authentication module can be used to verify the identity and other security concerns at the entrypoint to the docker-compose cluster.</p>
<p>We will use the <code>datawire/ambassador-auth-service</code> container as an example.</p>
<h3 id="create-docker-composeyaml-service-entry">Create docker-compose.yaml service entry</h3>
<p>Update the <code>docker-compose.yaml</code> file to include the new <code>auth</code> service:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&apos;3.5&apos;</span>

<span class="hljs-attr">services:</span>
<span class="hljs-attr">  ambassador:</span>
<span class="hljs-attr">    image:</span> quay.io/datawire/ambassador:<span class="hljs-number">0.38</span><span class="hljs-number">.0</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">8080</span>:<span class="hljs-number">80</span>
<span class="hljs-attr">    volumes:</span>
    <span class="hljs-comment"># mount a volume where we can inject configuration files</span>
<span class="hljs-bullet">    -</span> ./config:/ambassador/ambassador-config
<span class="hljs-attr">  qotm:</span>
<span class="hljs-attr">    image:</span> datawire/qotm:<span class="hljs-number">1.3</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">5000</span>
<span class="hljs-attr">  auth:</span>
<span class="hljs-attr">    image:</span> datawire/ambassador-auth-service:latest
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">3000</span>
</code></pre>
<h3 id="create-the-authyaml-configuration">Create the auth.yaml configuration</h3>
<p>Make a new file called <code>config/auth.yaml</code> with an auth definition inside:</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> ambassador/v0
<span class="hljs-attr">kind:</span>  AuthService
<span class="hljs-attr">name:</span>  authentication
<span class="hljs-attr">auth_service:</span> <span class="hljs-string">&quot;auth:3000&quot;</span>
<span class="hljs-attr">path_prefix:</span> <span class="hljs-string">&quot;/extauth&quot;</span>
<span class="hljs-attr">allowed_headers:</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">&quot;x-qotm-session&quot;</span>
</code></pre>
<p>This configuration will use the <code>AuthService</code> object to ensure that all requests made to ambassador are first sent to the <code>auth</code> docker container on port <code>3000</code> before being routed to the service that is mapped to the desired route. See the Authentication documentation for more details.</p>
<h3 id="verify-that-authentication-is-working">Verify that Authentication is working</h3>
<p>This sample authentication service only supports basic auth on a specific route. While the route is hardcoded you can implement your own that covers all routes. We will demonstrate that accessing the authenticated route with an incorrect Authorization header will result in a 401.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># start all new containers (eg. auth)</span>
docker-compose up <span class="hljs-_">-d</span>

<span class="hljs-comment"># restart the api gateway to pick up new configuration settings</span>
docker-compose up <span class="hljs-_">-d</span> -V ambassador

<span class="hljs-comment"># curl the quote-of-the-moment service without an auth header</span>
curl -I localhost:8080/qotm/quote/1

<span class="hljs-comment"># the response should look like this</span>
HTTP/1.1 401 Unauthorized
x-powered-by: Express
x-request-id: da059f3e-7b9e-4d98-8428<span class="hljs-_">-f</span>4f8ca742af7
www-authenticate: Basic realm=<span class="hljs-string">&quot;Ambassador Realm&quot;</span>
content-type: text/html; charset=utf-8
content-length: 0
etag: W/<span class="hljs-string">&quot;0-2jmj7l5rSw0yVb/vlWAYkK/YBwk&quot;</span>
date: Fri, 17 Aug 2018 22:25:38 GMT
x-envoy-upstream-service-time: 1
server: envoy

<span class="hljs-comment"># now try with a specific username and password</span>
curl -I --user username:password localhost:8080/qotm/quote/1

<span class="hljs-comment"># the response should be a 200</span>
HTTP/1.1 200 OK
content-type: application/json
x-qotm-session: 5b75f31f-1155-4827-ab28-74d0f98573da
content-length: 217
server: envoy
date: Fri, 17 Aug 2018 22:29:43 GMT
x-envoy-upstream-service-time: 2
</code></pre>
<h2 id="5-tracing">5. Tracing</h2>
<p>As a final example we will configure Ambassador to send Zipkin traces to Jaeger. Integrating Zipkin into your services can be a vital glimpse into the performance bottlenecks of a distributed system.</p>
<h3 id="add-the-jaeger-container-to-the-docker-composeyaml-file">Add the Jaeger container to the docker-compose.yaml file</h3>
<p>Building on our original <code>docker-compose.yaml</code> file, we can add a new service called <code>tracing</code> to the list:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&apos;3.5&apos;</span>

<span class="hljs-attr">services:</span>
<span class="hljs-attr">  ambassador:</span>
<span class="hljs-attr">    image:</span> quay.io/datawire/ambassador:<span class="hljs-number">0.38</span><span class="hljs-number">.0</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">8080</span>:<span class="hljs-number">80</span>
<span class="hljs-attr">    volumes:</span>
    <span class="hljs-comment"># mount a volume where we can inject configuration files</span>
<span class="hljs-bullet">    -</span> ./config:/ambassador/ambassador-config
<span class="hljs-attr">  qotm:</span>
<span class="hljs-attr">    image:</span> datawire/qotm:<span class="hljs-number">1.3</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">5000</span>
<span class="hljs-attr">  auth:</span>
<span class="hljs-attr">    image:</span> datawire/ambassador-auth-service:latest
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-number">3000</span>
<span class="hljs-attr">  tracing:</span>
<span class="hljs-attr">    image:</span> jaegertracing/all-in-one:latest
<span class="hljs-attr">    environment:</span>
<span class="hljs-attr">      COLLECTOR_ZIPKIN_HTTP_PORT:</span> <span class="hljs-number">9411</span>
<span class="hljs-attr">    ports:</span> 
<span class="hljs-bullet">      -</span> <span class="hljs-number">5775</span>:<span class="hljs-number">5775</span>/udp
<span class="hljs-bullet">      -</span> <span class="hljs-number">6831</span>:<span class="hljs-number">6831</span>/udp
<span class="hljs-bullet">      -</span> <span class="hljs-number">6832</span>:<span class="hljs-number">6832</span>/udp
<span class="hljs-bullet">      -</span> <span class="hljs-number">5778</span>:<span class="hljs-number">5778</span>
<span class="hljs-bullet">      -</span> <span class="hljs-number">16686</span>:<span class="hljs-number">16686</span>
<span class="hljs-bullet">      -</span> <span class="hljs-number">14268</span>:<span class="hljs-number">14268</span>
<span class="hljs-bullet">      -</span> <span class="hljs-number">9411</span>:<span class="hljs-number">9411</span>
</code></pre>
<h3 id="create-a-tracing-configuration-file-for-ambassador">Create a tracing configuration file for Ambassador</h3>
<p>Add a new configuration file <code>config/tracing.yaml</code> with these contents:</p>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> ambassador/v0
<span class="hljs-attr">kind:</span> TracingService
<span class="hljs-attr">name:</span> tracing
<span class="hljs-attr">service:</span> tracing:<span class="hljs-number">9411</span>
<span class="hljs-attr">driver:</span> zipkin
</code></pre>
<p>This will forward all of Ambassador&apos;s traces to the <code>tracing</code> service.</p>
<h3 id="make-requests-and-observe-the-traces">Make requests and observe the traces</h3>
<p>After reloading the Docker containers and configuration we should be able to make requests to the qotm service and see the traces in the Jaeger front-end UI.</p>
<pre><code class="lang-bash"><span class="hljs-comment"># start all new containers (eg. tracing)</span>
docker-compose up <span class="hljs-_">-d</span>

<span class="hljs-comment"># restart the api gateway to pick up new configuration settings</span>
docker-compose up <span class="hljs-_">-d</span> -V ambassador

<span class="hljs-comment"># curl the quote-of-the-moment service as many times as you would like</span>
curl --user username:password localhost:8080/qotm/quote/1
</code></pre>
<p>In a browser you can go to <a href="http://localhost:16686/" target="_blank">http://localhost:16686/</a> and search for traces. To make this demonstration more useful one should implement Zipkin tracing middleware into their webserver.</p>
<h2 id="next-steps">Next Steps</h2>
<p>We have demonstrated that all the configurations that would normally be stored in kubernetes annotations can be saved as a yaml document in a volume mapped to <code>/ambassador/ambassador-config</code> within the Ambassador docker container. Hopefully this guide can be used to test new configurations locally before moving to a Kubernetes cluster. Of course, there will be differences between docker-compose and the Kubernetes implementation and one should be sure to test thoroughly in the latter before moving to production.</p>

                                

                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../about/quickstart.html" class="navigation navigation-prev " aria-label="Previous page: Docker Quickstart">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../concepts/developers.html" class="navigation navigation-next " aria-label="Next page: Decentralized configuration">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Docker Compose","level":"2.3.4","depth":2,"next":{"title":"Decentralized configuration","level":"3.1","depth":1,"path":"concepts/developers.md","ref":"concepts/developers.md","articles":[]},"previous":{"title":"Docker Quickstart","level":"2.3.3","depth":2,"path":"about/quickstart.md","ref":"about/quickstart.md","articles":[]},"dir":"ltr"},"config":{"plugins":["gtm","anchorjs"],"root":".","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"gtm":{"token":"GTM-TPMQ838","virtualPageViews":true},"search":{},"layout":{"footerPath":"layouts/footer.html"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchorjs":{"selector":"h2,h3,h4,h5","placement":"right","visible":"always","truncate":64,"ariaLabel":"Anchor"}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"INDEX.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Ambassador: open source API Gateway for microservices and Kubernetes","gitbook":"*"},"file":{"path":"user-guide/docker-compose.md","mtime":"2020-08-25T18:44:25.448Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-09-14T18:10:30.972Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>


        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-gtm/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-anchorjs/anchor.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-anchorjs/anchor-style.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="/js/datawire-breadcrumb.js" type="text/javascript"></script>

    </body>
</html>

